<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Socket.IO Chat Test</title>
</head>
<body>
  <h2>Socket.IO Chat Test</h2>

  <label>Sender ID: <input id="senderId" placeholder="Sender User ID" /></label><br>
  <label>Receiver ID: <input id="receiverId" placeholder="Receiver User ID" /></label><br>
  <label>Chat Type:
    <select id="chatType">
      <option value="direct">Direct</option>
      <option value="anonymous">Anonymous</option>
    </select>
  </label><br>

  <button onclick="joinRoom()">Join Chat</button>
  <button onclick="fetchUserChats()">Show My Chats</button>

  <div id="chat" style="margin-top:20px; display:none;">
    <div id="messages" style="border:1px solid #aaa; padding:10px; height:200px; overflow:auto;"></div>
    <input id="messageInput" placeholder="Enter message..." />
    <button onclick="sendMessage()">Send</button>
  </div>

  <h3>My Chat Rooms <span id="notificationBadge" style="background:red; color:white; border-radius:50%; padding:2px 6px; font-size:12px; display:none;">0</span></h3>
  <ul id="chatList" style="border:1px solid #aaa; padding:10px; max-height:150px; overflow:auto;"></ul>

  <!-- Notification area -->
  <div id="notificationArea" style="position:fixed; top:20px; right:20px; max-width:300px; z-index:1000;"></div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const socket = io('https://node-service-tavat.dev.idea2mvp.in', { autoConnect: false });
    const senderId = document.getElementById('senderId')?.value?.trim();
    if (!senderId) {
      alert('Please enter a Sender ID to start seeing the chat list.');
    }
    const chatListSocket = io('https://node-service-tavat.dev.idea2mvp.in/chat-list', {
      autoConnect: false,
      query: {
        userId: senderId
      }
    });

    chatListSocket.connect();


    let currentRoomId = null;
    let currentChatType = 'direct';
    let notificationCount = 0;
    let chatRoomsData = {}; 

    socket.on('connect', () => console.log('Main socket connected:', socket.id));
    socket.on('disconnect', () => console.log('Main socket disconnected'));

    chatListSocket.on('connect', () => console.log('Chat-list socket connected:', chatListSocket.id));
    chatListSocket.on('disconnect', () => console.log('Chatâ€‘list socket disconnected'));

    // Listen only on chatListSocket for new room and message notifications
    chatListSocket.on('newRoomCreated', roomData => {
      console.log('New room from chat-list:', roomData);
      chatRoomsData[roomData.roomId] = roomData;
      updateChatListDisplay();
      showNotification('New chat room created!', 'info');
      updateNotificationBadge(1);
    });

    chatListSocket.on('chatListUpdate', notificationData => {
      console.log('Chat list update from chat-list:', notificationData);
      const { roomId, lastText, userName } = notificationData;
      if (chatRoomsData[roomId]) {
        chatRoomsData[roomId].displayUsers.forEach(userObj => {
          userObj.userName = userName;
          userObj.lastText = lastText;
        });
        updateChatListDisplay();
      }
      if (currentRoomId !== roomId) {
        showNotification(`${userName}: ${lastText}`, 'message');
        updateNotificationBadge(1);
      }
    });

    function joinRoom(roomId = null) {
      const senderId = document.getElementById('senderId').value.trim();
      const receiverId = document.getElementById('receiverId').value.trim();
      const chatType = document.getElementById('chatType').value;
      if (!senderId || !receiverId) return alert('Both Sender and Receiver IDs are required!');
      if (!socket.connected) socket.connect();
      let payload = { senderId, receiverId, roomType: chatType };
      if (roomId) payload.roomId = roomId;
      socket.emit('join', payload, (err, data) => {
        if (err) return alert('Join Error: ' + (err.message || err));
        currentRoomId = data.room;
        currentChatType = chatType;
        document.getElementById('chat').style.display = 'block';
        document.getElementById('messages').innerHTML = '';
        data.messages?.forEach(renderMessage);
      });
    }

    socket.on('message', msg => renderMessage(msg));

    function sendMessage() {
      const message = document.getElementById('messageInput').value.trim();
      const senderId = document.getElementById('senderId').value.trim();
      if (!message || !currentRoomId) return;
      socket.emit('sendMessage', { roomId: currentRoomId, message, senderId }, () => {
        document.getElementById('messageInput').value = '';
      });
    }

    function fetchUserChats() {
      const senderId = document.getElementById('senderId').value.trim();
      if (!senderId) return alert('Enter Sender ID to fetch chats');
      if (!chatListSocket.connected) chatListSocket.connect();
      chatListSocket.emit('init', { userId: senderId }, (err, response) => {
        if (err) return alert('Error fetching chats: ' + (err.message || err));
        chatRoomsData = {};
        response.chats?.forEach(chatRoom => {
          chatRoomsData[chatRoom.roomId] = chatRoom;
        });
        updateChatListDisplay();
      });
    }

    function updateChatListDisplay() {
      const ul = document.getElementById('chatList');
      ul.innerHTML = '';
      const rooms = Object.values(chatRoomsData);
      if (!rooms.length) return ul.innerHTML = '<li>No chats found</li>';
      rooms.forEach(cr => {
        const li = document.createElement('li');
        li.style = 'cursor:pointer; border:1px solid #ccc; margin:6px 0; padding:8px; border-radius:4px; background:#f9f9f9;';
        li.innerHTML = `
          <div><strong>Room:</strong> ${cr.roomId} &nbsp; <strong>Type:</strong> ${cr.chatType}</div>
        `;
        cr.displayUsers.forEach(u => {
          const div = document.createElement('div');
          div.style = 'background:#fff; padding:4px 8px; margin:4px 0; border-radius:3px;';
          div.textContent = `${u.userName}: ${u.lastText || ''}`;
          li.appendChild(div);
        });
        li.onclick = () => {
          const senderId = document.getElementById('senderId').value.trim();
          const otherId = cr.participantIds.find(id => id !== senderId);
          if (otherId) document.getElementById('receiverId').value = otherId;
          document.getElementById('chatType').value = cr.chatType || 'direct';
          notificationCount = 0;
          updateNotificationBadge();
          joinRoom(cr.roomId);
        };
        ul.appendChild(li);
      });
    }

    function renderMessage(msg) {
      const box = document.getElementById('messages');
      const div = document.createElement('div');
      const when = msg.createdAt ? (() => {
        const diff = new Date() - new Date(msg.createdAt);
        const mins = Math.floor(diff / 60000);
        return mins > 59 ? Math.floor(mins/60) + 'h ago' : (mins > 0 ? mins+'m ago' : 'just now');
      })() : '';
      div.textContent = `[${msg.username}] ${msg.text}` + (when ? ` (${when})` : '');
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    function showNotification(text, type = 'info') {
      const area = document.getElementById('notificationArea');
      const div = document.createElement('div');
      div.style = `background:${type==='message'?'#4CAF50':type==='success'?'#2196F3':'#FF9800'}; color:white; padding:10px; margin-bottom:8px; border-radius:5px;`;
      div.textContent = text;
      div.onclick = () => div.remove();
      area.appendChild(div);
      setTimeout(() => div.remove(), 5000);
    }

    function updateNotificationBadge(inc = 0) {
      notificationCount += inc;
      const badge = document.getElementById('notificationBadge');
      badge.textContent = notificationCount;
      badge.style.display = notificationCount > 0 ? 'inline' : 'none';
    }

    document.head.insertAdjacentHTML('beforeend', `
      <style>@keyframes slideIn { from {transform:translateX(100%);opacity:0;} to{transform:translateX(0);opacity:1;} }</style>
    `);
  </script>
</body>
</html>
